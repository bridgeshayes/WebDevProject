<!--
    Authors:    Garrett Hayes, Wes Talley, Johnny Mac Brentlinger, Gavin Davis, Kaylee Miller
	Course:     CSC 3100-001
	Date:       23 February 2024
    Due:        6 March 2024
	File:       index.html
	Purpose:    This single page application is the basis of the Smart Chicken Coop Product by the SwollenHippo Company.
                It contains a login page for returning users along with a registration page for new users receiving their Smart Coop and a dashboard which is currently blank. 
                This application uses CSS and Jquery for apperance and functionality along with incorporating error handling by SweetAlerts2 and input validation by regular expression.
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Coop</title>
    <link href="assets/css/index.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body class="container">
    <!-- This is the Login Card which appears on startup, and has a button for the Registration Card. -->
    <div id="divMain" class="d-flex col-12 justify-content-center align-items-center vh-100">
        <div id="divLogin" class="card col-12 col-md-8 col-lg-5" style="background-color: #e8e0c8;">
            <p class="login-header mt-4">Smart Coop</p>
            <div class="card-body">
                <form>
                    <div>
                        <label for="txtLoginEmail"> Email </label>
                        <input type="email" placeholder="Email" aria-label="Email"
                            class="form__group_oneform__field col-12 mt-2 mb-4 " id="txtLoginEmail">

                        <label for="txtLoginPassword"> Password </label>
                        <input type="password" placeholder="Password (8+ characters)" aria-label="Password"
                            class="form__group_oneform__field col-12 mt-2 mb-4" id="txtLoginPassword">
                    </div>

                    <button class="comic-button col-6 offset-3 mb-2" id="btnLogin" type="button"> Login </button>
                    <button class="col-8 comic-button mt-2 mb-4 btnToggle offset-2" type="button" data-type="login">
                        Need an account? </button>
                </form>
            </div>
        </div>
        <!--This is the Registration Card for new users, and can be accessed by the Login Card. -->
        <div id="divRegister" class="card col-12 col-md-8 col-lg-5 mt-4 mb-4"
            style="background-color: #e8e0c8; display:none">
            <p class="login-header mt-4">Register</p>
            <div class="card-body">
                <form id="formRegister">
                    <div class="form-group">
                        <label for="txtFirstName" class="form-label"> First Name </label>
                        <input id="txtFirstName" placeholder="First Name" aria-label="First Name"
                            class="form__group_oneform__field col-12 mb-2">
                    </div>

                    <div class="form-group">
                        <label for="txtLastName" class="form-label mt-2"> Last Name </label>
                        <input id="txtLastName" placeholder="Last Name" aria-label="Last Name"
                            class="form__group_oneform__field col-12 mb-2">
                    </div>
                    <hr>

                    <div class="form-group">
                        <label for="txtStreetAddress1" class="form-label"> Street Address 1 </label>
                        <input id="txtStreetAddress1" placeholder="Street Address Line 1"
                            aria-label="Street Address Line One" class="form__group_oneform__field col-12 mb-2">
                    </div>

                    <!-- This checkbox is used to auto fill / delete the txtStreetAddress2 box based on the contents of txtStreetAddress1 -->
                    <label for="btnFillStAdd"> Street Address 2 not necessary</label>
                    <input type="checkbox" id="btnFillStAdd" class="mt-2 mb-3">

                    <div class="form-group">
                        <label for="txtStreetAddress2" class="form-label mt-2"> Street Address 2 (Optional)</label>
                        <input id="txtStreetAddress2" placeholder="Street Address Line 2"
                            aria-label="Street Address Line Two" class="form__group_oneform__field col-12 mb-2">
                    </div>
                    <hr>

                    <div class="form-group">
                        <label for="txtCity" class="form-label"> City </label>
                        <input id="txtCity" placeholder="City" aria-label="City"
                            class="form__group_oneform__field col-12 mb-2">
                    </div>

                    <div class="form-group">
                        <label for="txtState" class="form-label mt-2"> State </label>
                        <input id="txtState" placeholder="State" aria-label="State"
                            class="form__group_oneform__field col-12 mb-2">
                    </div>

                    <div class="form-group">
                        <label for="txtZipCode" class="form-label mt-2"> Zip Code </label>
                        <input id="txtZipCode" placeholder="Zip Code" aria-label="Zip Code"
                            class="form__group_oneform__field col-12 mb-2">
                    </div>
                    <hr>

                    <div class="form-group">
                        <label for="txtPhoneNumber" class="form-label"> Phone Number </label>
                        <input id="txtPhoneNumber" placeholder="Phone Number" aria-label="Phone Number"
                            class="form__group_oneform__field col-12 mb-2" type="tel">
                    </div>

                    <div class="form-group">
                        <label for="txtEmail" class="form-label mt-2"> Email </label>
                        <input id="txtEmail" placeholder="Email" aria-label="Email"
                            class="form__group_oneform__field col-12 mb-2" type="email" pattern="/[^0-9a-zA-Z_\-@.\s]/">
                    </div>

                    <div class="form-group">
                        <label for="txtPassword" class="form-label mt-2"> Password </label>
                        <input id="txtPassword" placeholder="Password (8+ characters)" aria-label="Password"
                            class="form__group_oneform__field col-12 mb-2" type="password"
                            pattern="/(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}/">
                    </div>

                    <div class="form-group">
                        <label for="txtCoopRegisterID" class="form-label mt-2"> Coop Registration ID </label>
                        <input id="txtCoopRegisterID" placeholder="Coop Registration ID"
                            aria-label="Coop Registration ID" class="form__group_oneform__field col-12 mb-2">
                    </div>
                    <hr>

                    <button class="col-6 offset-3 comic-button mt-2" id="btnRegister" type="button"> Register </button>
                    <button class="col-8 offset-2 comic-button mt-3 mb-4 btnToggle" id="btnReturnToLogin" type="button">
                        Return to Login </button>
                </form>
            </div>
        </div>
        <!-- This is the Dashboard Card, -->
        <div id="divDashboard" class="card col-12 row" style="background-color: #e8e0c8; display:none; ">
            <!-- add display:none; when finished. -->
            <div class="login-header mt-4 ">
                <h2>Dashboard</h2>
            </div>
            <div class="card-body col-6">

                <label for="cboEggColletionTime" class="form-label mt-3">Egg Collection Time </label>
                <select id="cboEggColletionTime" placeholder="Egg Colletion Time" aria-label="Egg Collection Time"
                    class="form__group_oneform__field col-12 mb-2">
                    <option> </option>
                    <option> Before Sunrise</option>
                    <option> Morning (After Sunrise)</option>
                    <option> Midday</option>
                    <option> Afternoon</option>
                    <option> Night (After Sunset)</option>
                    <option> Midnight</option>
                </select>

                <div class="form-group">
                    <label for="txtEggCounter" class="form-label mt-3"> Number of Eggs Harvested </label>
                    <input id="txtEggCounter" placeholder="Number of Eggs Harvested"
                        aria-label="Number of Eggs Harvested" class="form__group_oneform__field col-12 mb-2">
                </div>
                <hr>

                <button class="col-6 offset-3 comic-button mt-2" id="btnEggCounter" type="button"> Enter Eggs Harvested
                </button>
                <button class="col-8 offset-2 comic-button mt-3 mb-4" id="btnShowEggs" type="button"> Show Total Egg
                    Count </button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // These regular expressions are used to validate the user's email and password. 
        var regexEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        var regexPassword = /(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}/;
        var regexPhoneNumber = /^(\+\d{1,2}\s)?\(?\d{3}\)?[\s.-]\d{3}[\s.-]\d{4}$/;



        /*
            eggs.php API call: Place all functions below regarding the eggs.php endpoint
            TODO:
                POST - We need a POST option inside of btnEnterEggs.
                GET - We need a GET option that retrieves the egg records (will always be an array).
            DONE: 

        */

        /*
            environment.php API call: Place all functions below regarding the environment.php endpoint
            TODO: 
                POST - We need a button that allows us to enter environment data into a form and POST.
                DELETE - We need a remove environment data button that takes in a certain ID to remove.
                GET - We need a button that takes in certain days and returns the weather conditions for those days (an array).
            DONE:

        */

        /*
            sessions.php API call: Place all functions below regarding the sessions.php endpoint
            TODO: 
                POST - This is the login button that verifies the credentials and returns a new SessionID.
                PUT - This will be used to update the database with the last time that the SessionID was used.
                DELETE - This is called to free the SessionID from the database table once the session is over.
            IN PROGRESS:
                GET - Checks the last time the SessionID was used to see if they need to sign in again.
            DONE:
        */
        $.getJSON('https://simplecoop.swollenhippo.com/sessions.php', { SessionID: sessionStorage.getItem('SessionID') }, function (session) {
            if (session) {
                console.log(session)
            }
        })

        /*
            settings.php API call: Place all functions below regarding the settings.php endpoint
            TODO:
                POST- Takes in user-defined settings and stores them in the settings table.
                PUT - Updates said settings.
                DELETE - Removes said settings from table.
                GET - Retrives said settings.
            DONE:

        */


        /*
            useraddress.php API call: Place all functions below regarding the useraddess.php endpoint
            TODO:
                PUT - Updates the address.
                DELETE - Removes the row associated with an email.
                GET - Returns an address linked to an email.
            DONE:
                POST - Creates an address associated with an email.
        */

        /*
            users.php API call: Place all functions below regarding the users.php endpoint
            TODO:
                PUT - Update account info, minus the CoopID.
                DELETE - Delete the account from users.
                GET - Return the account info.
            DONE:
                POST - Register an account.
        */

        // This is the function that adds / clears out txtStreetAddress2 based on the contents of txtStreetAddress1
        $('#btnFillStAdd').on('click', function () {
            if ($('#txtStreetAddress1').val() && $('#txtStreetAddress2').val() == '') {
                $('#txtStreetAddress2').val($('#txtStreetAddress1').val())
            }
            else {
                $('#txtStreetAddress2').val('')
            }
        })

        // This is the function that toggles the Login and Registration Pages.
        $('.btnToggle').on('click', function () {
            let page = $(this).attr('data-type');

            if (page == 'login') {
                $('#divLogin').slideToggle(function () {
                    $('#divMain').removeClass('vh-100');
                    $('#divRegister').slideToggle('slow');
                })
            }
            else {
                // clears the registration form if we return to login.
                $('#txtFirstName').val('');
                $('#txtLastName').val('');
                $('#txtStreetAddress1').val('');
                $('#txtStreetAddress2').val('');
                $('#txtCity').val('');
                $('#txtState').val('');
                $('#txtZipCode').val('');
                $('#txtPhoneNumber').val('');
                $('#txtEmail').val('');
                $('#txtPassword').val('');
                $('#txtCoopRegisterID').val('');

                $('#divRegister').slideToggle(function () {
                    $('#divMain').addClass('vh-100')
                    $('#divLogin').slideToggle('slow');
                })
            }
        })

        // This is the function that validates the email and password by the use of regular expressions on the Login Card. 
        $('#btnLogin').on('click', function () {
            let strEmail = $('#txtLoginEmail').val();
            let strPassword = $('#txtLoginPassword').val();
            let strError = ''

            if (!regexEmail.test(strEmail)) {
                strError += '<p>Invalid Email (must have a "@", ".", and be a valid length)</p>';
            }

            if (!regexPassword.test(strPassword)) {
                strError += '<p>Invalid Password (Must have 8+ characters with 1 digit, 1 upper case and 1 lower case character)</p>';
            }

            if (strError) {
                Swal.fire({
                    title: 'Oops!',
                    html: strError,
                    icon: 'error'
                });
            }
            else {
                $.getJSON('https://simplecoop.swollenhippo.com/users.php', { Email: strEmail }, function (user) {
                    if (user.Password == strPassword) {
                        $.post('https://simplecoop.swollenhippo.com/sessions.php', { Email: strEmail, Password: strPassword }, function (session) {
                            if (session) {
                                session = JSON.parse(session)
                                sessionStorage.setItem('SessionID', session.SessionID)
                                Swal.fire({
                                    icon: 'success',
                                    text: 'Created a session!',
                                    title: 'Success'
                                })
                                $('#divLogin').slideToggle(function () {
                                    $('#divDashboard').slideToggle()
                                })
                            }
                            else {
                                Swal.fire({
                                    icon: 'error',
                                    text: 'No session!',
                                    title: 'Error'
                                })
                            }
                        })
                    }
                    else {
                        Swal.fire({
                            icon: 'error',
                            text: 'Invalid password!',
                            title: 'Error'
                        })
                    }
                })

            }
        })

        // This is the function that validates all input on the Registration Card using length and regular expressions.
        $('#btnRegister').on('click', function () {
            let strError = '';

            let strFirstName = $('#txtFirstName').val();
            let strLastName = $('#txtLastName').val();
            let strStAdd1 = $('#txtStreetAddress1').val();
            let strStAdd2 = $('#txtStreetAddress2').val();
            let strCity = $('#txtCity').val();
            let strState = $('#txtState').val();
            let strZip = $('#txtZipCode').val();
            let strPhoneNumber = $('#txtPhoneNumber').val();
            let strEmail = $('#txtEmail').val();
            let strPassword = $('#txtPassword').val();
            let strCoopID = $('#txtCoopRegisterID').val();

            if (strFirstName.length < 1) {
                strError += '<p>Invalid First Name (cannot be blank)</p>';
            }
            if (strLastName.length < 1) {
                strError += '<p>Invalid Last Name (cannot be blank)</p>';
            }
            if (strStAdd1.length < 2) {
                strError += '<p>Invalid Address (must be at least 2 characters)</p>';
            }
            if (strCity.length < 2) {
                strError += '<p>Invalid City (must be at least 2 characters)</p>';
            }
            if (strState.length < 2) {
                strError += '<p>Invalid State (must be at least 2 characters)</p>';
            }
            if (strZip.length != 5) {
                strError += '<p>Invalid Zip Code (must be 5 characters)</p>';
            }
            if (!regexPhoneNumber.test(strPhoneNumber)) {
                strError += '<p> Invalid Phone Number (Format: (xxx) xxx-xxxx)</p>'
            }
            if (!regexEmail.test(strEmail)) {
                strError += '<p>Invalid Email (must have a "@", ".", and be a valid length)</p>';
            }
            if (!regexPassword.test(strPassword)) {
                strError += '<p>Invalid Password (Must have 8+ characters with 1 digit, 1 upper case and 1 lower case character)</p>';
            }
            if (strCoopID != '2RXVJZT0') {
                strError += '<p>Invalid Coop ID (Must be 4 digits)</p>'
            }

            if (strError) {
                Swal.fire({
                    title: 'Oops!',
                    html: strError,
                    icon: 'error',
                });
            }
            else {
                $.post('https://simplecoop.swollenhippo.com/usersaddress.php', { Email: strEmail, Street1: strStAdd1, Street2: strStAdd2, City: strCity, State: strState, ZIP: strZip }, function (result) {
                    console.log(result);
                })
                $.post('https://simplecoop.swollenhippo.com/user.php', { Email: strEmail, Password: strPassword, FirstName: strFirstName, LastName: strLastName, CoopID: strCoopID }, function (result) {
                    console.log(result);
                })


                // clears all input on successful registration.
                $('#txtFirstName').val('');
                $('#txtLastName').val('');
                $('#txtStreetAddress1').val('');
                $('#txtStreetAddress2').val('');
                $('#txtCity').val('');
                $('#txtState').val('');
                $('#txtZipCode').val('');
                $('#txtPhoneNumber').val('');
                $('#txtEmail').val('');
                $('#txtPassword').val('');
                $('#txtCoopRegisterID').val('');

                Swal.fire({
                    title: 'Yippee!',
                    icon: 'success',
                });

                $('#divRegister').slideUp(function () {
                    $('#divDashboard').slideDown()
                });
            }
        });
    </script>
</body>

</html>